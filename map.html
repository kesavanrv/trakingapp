<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vehicle Live Tracking</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #info {
      padding: 8px 12px;
      font-size: 14px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      white-space: nowrap;
      overflow-x: auto;
    }

    #status {
      color: #0066cc;
      font-weight: 600;
    }

    /* This is the important part: give the map a height */
    #map {
      width: 100%;
      height: calc(100vh - 40px); /* full screen minus header */
    }
  </style>
</head>

<body>
  <div id="info">
    Vehicle: <span id="vehicle"></span> |
    Lat: <span id="lat">-</span> |
    Lon: <span id="lon">-</span> |
    Speed: <span id="speed">-</span> |
    Time: <span id="time">-</span> |
    Status: <span id="status">Waiting...</span>
  </div>

  <!-- Map container -->
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const API_BASE = "http://192.168.1.22:8000";  // your PC IP
    const VEHICLE_ID = "ANDROID01";

    const statusEl = document.getElementById("status");
    const latEl = document.getElementById("lat");
    const lonEl = document.getElementById("lon");
    const speedEl = document.getElementById("speed");
    const timeEl = document.getElementById("time");
    const vehicleEl = document.getElementById("vehicle");
    vehicleEl.textContent = VEHICLE_ID;

    // Create map
    const map = L.map("map").setView([12.97, 77.59], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    const markerIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/2329/2329157.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
    });

    let marker = null;
    let polyline = L.polyline([], { color: "blue", weight: 4 }).addTo(map);

    async function fetchLatest() {
      try {
        const url = `${API_BASE}/api/locations/latest?vehicle_id=${encodeURIComponent(
          VEHICLE_ID
        )}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (data.error) {
          statusEl.textContent = "No data yet for " + VEHICLE_ID;
          return;
        }

        const lat = data.lat;
        const lon = data.lon;
        const speed = data.speed;
        const timestamp = data.timestamp;

        statusEl.textContent = "Live tracking";
        latEl.textContent = lat.toFixed(6);
        lonEl.textContent = lon.toFixed(6);
        speedEl.textContent = speed.toFixed(2);
        timeEl.textContent = timestamp;

        const newLatLng = [lat, lon];

        if (!marker) {
          marker = L.marker(newLatLng, { icon: markerIcon }).addTo(map);
          map.setView(newLatLng, 16);
        } else {
          marker.setLatLng(newLatLng);
        }

        const latlngs = polyline.getLatLngs();
        const last = latlngs[latlngs.length - 1];
        if (!last || last.lat !== lat || last.lng !== lon) {
          polyline.addLatLng(newLatLng);
        }
      } catch (err) {
        console.error("Error fetching latest location:", err);
        statusEl.textContent = "Error talking to server";
      }
    }

    fetchLatest();
    setInterval(fetchLatest, 5000);
  </script>
</body>
</html>
