<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>

<script>
  const API_BASE = window.location.origin;
  const VEHICLE_ID = "ANDROID01";

  const statusEl = document.getElementById("status");
  const latEl = document.getElementById("lat");
  const lonEl = document.getElementById("lon");
  const speedEl = document.getElementById("speed");
  const timeEl = document.getElementById("time");
  document.getElementById("vehicle").textContent = VEHICLE_ID;

  const map = L.map("map").setView([12.97, 77.59], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap contributors",
  }).addTo(map);

  const markerIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/2329/2329157.png",
    iconSize: [32, 32],
    iconAnchor: [16, 32],
  });

  let marker = null;
  let polyline = L.polyline([], { weight: 4 }).addTo(map);
  let lastId = 0;

  async function loadHistory() {
    try {
      const url = `${API_BASE}/api/locations?vehicle_id=${encodeURIComponent(
        VEHICLE_ID
      )}&limit=1000`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const points = await resp.json();
      if (!points.length) {
        statusEl.textContent = "No data yet for " + VEHICLE_ID;
        return;
      }

      const latlngs = points.map(p => {
        lastId = Math.max(lastId, p.id);
        return [p.lat, p.lon];
      });

      polyline.setLatLngs(latlngs);
      const last = points[points.length - 1];

      if (!marker) {
        marker = L.marker([last.lat, last.lon], { icon: markerIcon }).addTo(map);
      } else {
        marker.setLatLng([last.lat, last.lon]);
      }

      map.fitBounds(polyline.getBounds(), { padding: [30, 30] });

      updateInfo(last);
      statusEl.textContent = "History loaded + live tracking";
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Error loading history";
    }
  }

  function updateInfo(p) {
    latEl.textContent = p.lat.toFixed(6);
    lonEl.textContent = p.lon.toFixed(6);
    speedEl.textContent = p.speed.toFixed(2);
    timeEl.textContent = p.timestamp;
  }

  async function pollNewPoints() {
    try {
      const url = `${API_BASE}/api/locations?vehicle_id=${encodeURIComponent(
        VEHICLE_ID
      )}&limit=2000`;
      const resp = await fetch(url);
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const points = await resp.json();
      if (!points.length) return;

      // if there are new points, redraw
      const newOnes = points.filter(p => p.id > lastId);
      if (!newOnes.length) return;

      const latlngs = points.map(p => [p.lat, p.lon]);
      polyline.setLatLngs(latlngs);

      const last = points[points.length - 1];
      lastId = last.id;

      if (!marker) {
        marker = L.marker([last.lat, last.lon], { icon: markerIcon }).addTo(map);
      } else {
        marker.setLatLng([last.lat, last.lon]);
      }

      updateInfo(last);
    } catch (err) {
      console.error("poll error", err);
      statusEl.textContent = "Error talking to server";
    }
  }

  // Load history when page opens
  loadHistory();
  // Then keep updating every 5 seconds
  setInterval(pollNewPoints, 5000);
</script>
