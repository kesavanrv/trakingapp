<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vehicle Live Tracking</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #info {
      padding: 6px 10px;
      font-size: 13px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      white-space: nowrap;
      overflow-x: auto;
    }

    #status {
      color: #0066cc;
      font-weight: 600;
    }

    #replayControls {
      margin-left: 10px;
    }

    #replayDate {
      font-size: 12px;
    }

    #map {
      width: 100%;
      height: calc(100vh - 40px);
    }
  </style>
</head>

<body>
  <div id="info">
    Vehicle:
    <select id="vehicleSelect"></select>
    |
    Lat: <span id="lat">-</span> |
    Lon: <span id="lon">-</span> |
    Speed: <span id="speed">-</span> |
    Time: <span id="time">-</span> |
    Status: <span id="status">Waiting...</span>
    |
    Mode:
    <label><input type="radio" name="mode" value="live" checked /> Live</label>
    <label><input type="radio" name="mode" value="replay" /> Replay</label>

    <span id="replayControls">
      Date:
      <input type="date" id="replayDate" />
      <button id="loadDay">Load</button>
    </span>
  </div>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const API_BASE = window.location.origin;

    const statusEl = document.getElementById("status");
    const latEl = document.getElementById("lat");
    const lonEl = document.getElementById("lon");
    const speedEl = document.getElementById("speed");
    const timeEl = document.getElementById("time");
    const vehicleSelect = document.getElementById("vehicleSelect");
    const replayDateInput = document.getElementById("replayDate");
    const loadDayBtn = document.getElementById("loadDay");

    const modeRadios = document.querySelectorAll('input[name="mode"]');

    let currentVehicle = null;
    let mode = "live";
    let liveTimer = null;

    // ----- Leaflet map -----
    const map = L.map("map").setView([12.97, 77.59], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    const markerIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/2329/2329157.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
    });

    let marker = null;
    let polyline = L.polyline([], { color: "blue", weight: 4 }).addTo(map);

    function resetTrack() {
      if (marker) {
        map.removeLayer(marker);
        marker = null;
      }
      polyline.setLatLngs([]);
    }

    // ----- Vehicle list -----
    async function loadVehicles() {
      try {
        const resp = await fetch(`${API_BASE}/api/vehicles`);
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const vehicles = await resp.json();

        vehicleSelect.innerHTML = "";
        if (vehicles.length === 0) {
          const opt = document.createElement("option");
          opt.textContent = "NO DATA";
          opt.value = "";
          vehicleSelect.appendChild(opt);
          currentVehicle = null;
          statusEl.textContent = "No vehicles in DB yet";
          return;
        }

        vehicles.forEach((vid, index) => {
          const opt = document.createElement("option");
          opt.value = vid;
          opt.textContent = vid;
          vehicleSelect.appendChild(opt);
          if (index === 0) currentVehicle = vid;
        });

        vehicleSelect.value = currentVehicle;
      } catch (err) {
        console.error("Error loading vehicles:", err);
        statusEl.textContent = "Error loading vehicles";
      }
    }

    vehicleSelect.addEventListener("change", () => {
      currentVehicle = vehicleSelect.value;
      resetTrack();
      if (mode === "live") {
        statusEl.textContent = "Live tracking";
      } else {
        statusEl.textContent = "Pick a date and click Load";
      }
    });

    // ----- Mode switching -----
    modeRadios.forEach((r) => {
      r.addEventListener("change", () => {
        mode = document.querySelector('input[name="mode"]:checked').value;
        resetTrack();

        if (mode === "live") {
          statusEl.textContent = "Live tracking";
          startLivePolling();
        } else {
          statusEl.textContent = "Pick a date and click Load";
          stopLivePolling();
        }
      });
    });

    function startLivePolling() {
      stopLivePolling();
      fetchLatest(); // immediate
      liveTimer = setInterval(fetchLatest, 5000);
    }

    function stopLivePolling() {
      if (liveTimer) {
        clearInterval(liveTimer);
        liveTimer = null;
      }
    }

    // ----- LIVE polling -----
    async function fetchLatest() {
      if (!currentVehicle) return;

      try {
        const url = `${API_BASE}/api/locations/latest?vehicle_id=${encodeURIComponent(
          currentVehicle
        )}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (data.error) {
          statusEl.textContent = "No data yet for " + currentVehicle;
          return;
        }

        const lat = data.lat;
        const lon = data.lon;
        const speed = data.speed;
        const timestamp = data.timestamp;

        statusEl.textContent = "Live tracking";
        latEl.textContent = lat.toFixed(6);
        lonEl.textContent = lon.toFixed(6);
        speedEl.textContent = speed.toFixed(2);
        timeEl.textContent = timestamp;

        const newLatLng = [lat, lon];

        if (!marker) {
          marker = L.marker(newLatLng, { icon: markerIcon }).addTo(map);
          map.setView(newLatLng, 16);
        } else {
          marker.setLatLng(newLatLng);
        }

        const latlngs = polyline.getLatLngs();
        const last = latlngs[latlngs.length - 1];
        if (!last || last.lat !== lat || last.lng !== lon) {
          polyline.addLatLng(newLatLng);
        }
      } catch (err) {
        console.error("Error fetching latest:", err);
        statusEl.textContent = "Error talking to server";
      }
    }

    // ----- REPLAY by date -----
    loadDayBtn.addEventListener("click", loadReplayDay);

    async function loadReplayDay() {
      if (!currentVehicle) {
        alert("No vehicle selected");
        return;
      }
      const date = replayDateInput.value;
      if (!date) {
        alert("Please pick a date");
        return;
      }

      resetTrack();
      statusEl.textContent = `Loading ${currentVehicle} on ${date}...`;

      try {
        const url = `${API_BASE}/api/locations/by-date?vehicle_id=${encodeURIComponent(
          currentVehicle
        )}&date=${encodeURIComponent(date)}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const points = await resp.json();

        if (!points.length) {
          statusEl.textContent = "No data for that day";
          return;
        }

        const latlngs = points.map((p) => [p.lat, p.lon]);

        polyline.setLatLngs(latlngs);

        const first = latlngs[0];
        if (!marker) {
          marker = L.marker(first, { icon: markerIcon }).addTo(map);
        } else {
          marker.setLatLng(first);
        }

        const bounds = L.latLngBounds(latlngs);
        map.fitBounds(bounds, { padding: [20, 20] });

        const last = points[points.length - 1];
        latEl.textContent = last.lat.toFixed(6);
        lonEl.textContent = last.lon.toFixed(6);
        speedEl.textContent = last.speed.toFixed(2);
        timeEl.textContent = last.timestamp;

        statusEl.textContent = `Replay: ${currentVehicle} on ${date}`;
      } catch (err) {
        console.error("Error loading replay day:", err);
        statusEl.textContent = "Error loading replay data";
      }
    }

    // ----- Init -----
    (async function init() {
      await loadVehicles();
      if (currentVehicle) {
        mode = "live";
        document.querySelector('input[name="mode"][value="live"]').checked = true;
        startLivePolling();
      }
    })();
  </script>
</body>
</html>
