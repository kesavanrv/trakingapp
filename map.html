<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Vehicle Live Tracking & Trip Replay</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    #top-bar {
      padding: 6px 10px;
      font-size: 14px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    #info-line {
      white-space: nowrap;
      overflow-x: auto;
    }

    #status {
      color: #0066cc;
      font-weight: 600;
    }

    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      font-size: 13px;
    }

    #controls button {
      padding: 4px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background: #fff;
      cursor: pointer;
    }

    #controls button.active {
      background: #0066cc;
      color: white;
      border-color: #0050a8;
    }

    #controls input[type="date"] {
      padding: 2px 4px;
      font-size: 13px;
    }

    #map {
      width: 100%;
      height: calc(100vh - 70px); /* full screen minus header */
    }
  </style>
</head>

<body>
  <div id="top-bar">
    <div id="info-line">
      Mode: <span id="mode">Live</span> |
      Vehicle: <span id="vehicle"></span> |
      Lat: <span id="lat">-</span> |
      Lon: <span id="lon">-</span> |
      Speed: <span id="speed">-</span> |
      Time: <span id="time">-</span> |
      Status: <span id="status">Waiting...</span>
    </div>

    <div id="controls">
      <button id="liveBtn" class="active">Live</button>

      <span>History date:</span>
      <input type="date" id="dateInput" />
      <button id="loadTripBtn">Load Trip</button>
      <button id="playBtn" disabled>Play</button>
      <button id="pauseBtn" disabled>Pause</button>
    </div>
  </div>

  <!-- Map container -->
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const API_BASE = window.location.origin;
    const VEHICLE_ID = "ANDROID01";

    const statusEl = document.getElementById("status");
    const latEl = document.getElementById("lat");
    const lonEl = document.getElementById("lon");
    const speedEl = document.getElementById("speed");
    const timeEl = document.getElementById("time");
    const vehicleEl = document.getElementById("vehicle");
    const modeEl = document.getElementById("mode");

    const liveBtn = document.getElementById("liveBtn");
    const dateInput = document.getElementById("dateInput");
    const loadTripBtn = document.getElementById("loadTripBtn");
    const playBtn = document.getElementById("playBtn");
    const pauseBtn = document.getElementById("pauseBtn");

    vehicleEl.textContent = VEHICLE_ID;

    // Default date = today (browser time)
    const today = new Date().toISOString().slice(0, 10);
    dateInput.value = today;

    // Create map
    const map = L.map("map").setView([12.97, 77.59], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: "&copy; OpenStreetMap contributors",
    }).addTo(map);

    const markerIcon = L.icon({
      iconUrl: "https://cdn-icons-png.flaticon.com/512/2329/2329157.png",
      iconSize: [32, 32],
      iconAnchor: [16, 32],
    });

    let marker = null;
    let polyline = L.polyline([], { color: "blue", weight: 4 }).addTo(map);

    let pollTimer = null;   // for live mode
    let tripPoints = [];    // [[lat, lon], ...]
    let tripRaw = [];       // full objects from API
    let playIndex = 0;
    let playTimer = null;   // for replay

    // --------- Live Tracking ----------

    async function fetchLatest() {
      try {
        const url = `${API_BASE}/api/locations/latest?vehicle_id=${encodeURIComponent(
          VEHICLE_ID
        )}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();
        if (data.error) {
          statusEl.textContent = "No data yet for " + VEHICLE_ID;
          return;
        }

        const lat = data.lat;
        const lon = data.lon;
        const speed = data.speed;
        const timestamp = data.timestamp;

        statusEl.textContent = "Live tracking";
        latEl.textContent = lat.toFixed(6);
        lonEl.textContent = lon.toFixed(6);
        speedEl.textContent = speed.toFixed(2);
        timeEl.textContent = timestamp;

        const newLatLng = [lat, lon];

        if (!marker) {
          marker = L.marker(newLatLng, { icon: markerIcon }).addTo(map);
          map.setView(newLatLng, 16);
        } else {
          marker.setLatLng(newLatLng);
        }

        const latlngs = polyline.getLatLngs();
        const last = latlngs[latlngs.length - 1];
        if (!last || last.lat !== lat || last.lng !== lon) {
          polyline.addLatLng(newLatLng);
        }
      } catch (err) {
        console.error("Error fetching latest location:", err);
        statusEl.textContent = "Error talking to server";
      }
    }

    function startLive() {
      modeEl.textContent = "Live";
      liveBtn.classList.add("active");
      statusEl.textContent = "Live tracking enabled";

      // clear any replay timers
      stopReplay();

      if (pollTimer) clearInterval(pollTimer);
      fetchLatest();
      pollTimer = setInterval(fetchLatest, 5000);
    }

    function stopLive() {
      if (pollTimer) {
        clearInterval(pollTimer);
        pollTimer = null;
      }
    }

    // ---------- Trip Replay ----------

    function clearTripState() {
      tripPoints = [];
      tripRaw = [];
      playIndex = 0;
      stopReplay();
      playBtn.disabled = true;
      pauseBtn.disabled = true;
    }

    function stopReplay() {
      if (playTimer) {
        clearInterval(playTimer);
        playTimer = null;
      }
    }

    async function loadTrip() {
      stopLive();
      clearTripState();

      const dateVal = dateInput.value;
      if (!dateVal) {
        alert("Please pick a date first");
        return;
      }

      modeEl.textContent = "History";
      liveBtn.classList.remove("active");
      statusEl.textContent = `Loading trip for ${dateVal}...`;

      try {
        const url = `${API_BASE}/api/trip?vehicle_id=${encodeURIComponent(
          VEHICLE_ID
        )}&trip_date=${dateVal}`;
        const resp = await fetch(url);
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        const data = await resp.json();

        if (!Array.isArray(data) || data.length === 0) {
          statusEl.textContent = `No trip data found for ${dateVal}`;
          polyline.setLatLngs([]);
          return;
        }

        tripRaw = data;
        tripPoints = data.map((p) => [p.lat, p.lon]);

        // draw full path
        polyline.setLatLngs(tripPoints);

        const first = tripPoints[0];
        if (!marker) {
          marker = L.marker(first, { icon: markerIcon }).addTo(map);
        }
        marker.setLatLng(first);
        map.fitBounds(polyline.getBounds(), { padding: [30, 30] });

        // show info for first point
        const firstPoint = data[0];
        latEl.textContent = firstPoint.lat.toFixed(6);
        lonEl.textContent = firstPoint.lon.toFixed(6);
        speedEl.textContent = firstPoint.speed.toFixed(2);
        timeEl.textContent = firstPoint.timestamp;

        statusEl.textContent = `Trip replay loaded (${data.length} points)`;
        playIndex = 0;
        playBtn.disabled = false;
        pauseBtn.disabled = true;
      } catch (err) {
        console.error("Error loading trip:", err);
        statusEl.textContent = "Error loading trip from server";
      }
    }

    function playTrip() {
      if (!tripPoints.length) return;
      if (playTimer) return; // already playing

      statusEl.textContent = "Replaying trip...";
      playBtn.disabled = true;
      pauseBtn.disabled = false;

      playTimer = setInterval(() => {
        playIndex++;
        if (playIndex >= tripPoints.length) {
          stopReplay();
          statusEl.textContent = "Replay finished";
          playBtn.disabled = false;
          pauseBtn.disabled = true;
          return;
        }

        const pt = tripPoints[playIndex];
        const raw = tripRaw[playIndex];

        marker.setLatLng(pt);
        // You can pan the map if you want:
        // map.panTo(pt);

        latEl.textContent = raw.lat.toFixed(6);
        lonEl.textContent = raw.lon.toFixed(6);
        speedEl.textContent = raw.speed.toFixed(2);
        timeEl.textContent = raw.timestamp;
      }, 1000); // 1 second per point (adjust for slower/faster playback)
    }

    function pauseTrip() {
      if (!playTimer) return;
      stopReplay();
      statusEl.textContent = "Replay paused";
      playBtn.disabled = false;
      pauseBtn.disabled = true;
    }

    // ---------- Wire up buttons ----------

    liveBtn.addEventListener("click", () => {
      startLive();
    });

    loadTripBtn.addEventListener("click", () => {
      loadTrip();
    });

    playBtn.addEventListener("click", () => {
      playTrip();
    });

    pauseBtn.addEventListener("click", () => {
      pauseTrip();
    });

    // ---------- Start in LIVE mode by default ----------
    startLive();
  </script>
</body>
</html>
